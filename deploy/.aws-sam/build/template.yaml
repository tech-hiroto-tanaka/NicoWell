AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "NicoWell \u30D0\u30C3\u30AF\u30A8\u30F3\u30C9\u30B5\u30FC\u30D0\u30FC\
  \u30EC\u30B9\u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3"
Globals:
  Function:
    Timeout: 30
    Runtime: nodejs18.x
    MemorySize: 256
    Environment:
      Variables:
        OPENAI_API_KEY:
          Ref: OpenAIApiKey
Parameters:
  OpenAIApiKey:
    Type: String
    Description: "OpenAI API\u30AD\u30FC"
    NoEcho: true
Resources:
  AnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../lambda/deploy-packages/analysis-function.zip
      Handler: index.handler
      Description: "\u30E6\u30FC\u30B6\u30FC\u30D7\u30ED\u30D5\u30A3\u30FC\u30EB\u306E\
        \u5206\u6790\u3092\u884C\u3046\u95A2\u6570"
      Policies:
      - AWSLambdaBasicExecutionRole
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /analyze
            Method: post
            RestApiId:
              Ref: NicoWellApi
  ChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../lambda/deploy-packages/chat-function.zip
      Handler: index.handler
      Description: "\u30E6\u30FC\u30B6\u30FC\u3068\u306E\u30C1\u30E3\u30C3\u30C8\u5BFE\
        \u8A71\u3092\u51E6\u7406\u3059\u308B\u95A2\u6570"
      Policies:
      - AWSLambdaBasicExecutionRole
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /chat
            Method: post
            RestApiId:
              Ref: NicoWellApi
  SurveyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../lambda/deploy-packages/survey-function.zip
      Handler: index.handler
      Description: "\u30A2\u30F3\u30B1\u30FC\u30C8\u56DE\u7B54\u3092\u51E6\u7406\u3059\
        \u308B\u95A2\u6570"
      Policies:
      - AWSLambdaBasicExecutionRole
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /survey
            Method: post
            RestApiId:
              Ref: NicoWellApi
  NicoWellApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: '''POST, OPTIONS'''
        AllowHeaders: '''Content-Type'''
        AllowOrigin: '''*'''
Outputs:
  ApiUrl:
    Description: "API Gateway \u30A8\u30F3\u30C9\u30DD\u30A4\u30F3\u30C8URL"
    Value:
      Fn::Sub: https://${NicoWellApi}.execute-api.${AWS::Region}.amazonaws.com/prod
  AnalysisFunction:
    Description: "\u5206\u6790\u95A2\u6570\u306E\u540D\u524D"
    Value:
      Ref: AnalysisFunction
  ChatFunction:
    Description: "\u30C1\u30E3\u30C3\u30C8\u95A2\u6570\u306E\u540D\u524D"
    Value:
      Ref: ChatFunction
  SurveyFunction:
    Description: "\u30A2\u30F3\u30B1\u30FC\u30C8\u95A2\u6570\u306E\u540D\u524D"
    Value:
      Ref: SurveyFunction
